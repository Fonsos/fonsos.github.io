/*
 @name			 View.js — A simple, lightweight, jQuery photo viewer for the web
 @category   Lightbox, Image Viewer
 @author     Rogie King <rogie@finegoodsmarket.com>
 @copyright  2011-2011 Rogie King
 @version		 1.02 
 @license    By purchasing View.js, you agree to the following: View.js remain property of Rogie King. View.js may be used by the licensee in any personal or commercial projects. View.js may not be resold or  redistributed. For example: packaged in an application where it could be downloaded for free, such as an open-source project or other application where View.js is bundled along with other files.View.js — A simple, lightweight, jQuery photo viewer for the web by Rogie King is licensed under a Creative Commons Attribution-NoDerivs 3.0 Unported License.
*/

function View(a,b){
	function v(){t();
		q();
		d=c.find("img");
		g("body").append(c);

		if(!View._cssified){
			n()
		}
		View._cssified=true;
		u();
		i.sync();
		i.close();
		
		if(b.preload){
			i.show(d.eq(0))
		}
		i._ie7=navigator.userAgent.indexOf("MSIE 7")>-1;
		g(window).resize(function(){
			i.sync()
			}
		)
	}

	function u(){
		c.unbind("click.view").bind("click.view",m)
	}

	function t(){

		if(typeof a=="object"&&a.jquery){
			a.filter("a[href]").each(function(){
				if(s(this.href)||!b.validateUrls){
					h.push({src:this.href,caption:this.title})}g(this).unbind("click.view").bind("click.view",r)
				})
		}
		else if(g.isArray(a)){h=a}
	}

	function s(a){
		return/\.(jpeg|jpg|gif|png)(\?|#)?(.*)?$/ig.test(a)
	}

	function r(a){
		a.preventDefault();
		i.show(this.href);
		i.open()}

	function q(){
		if(g.isArray(h)){
			for(var a=0,b;b=h[a];++a){
				var c=null;var d=g('<li class="loading"/>');
				if(typeof b=="object"&&b.src){c=b.src}
				else if(typeof b=="string"){c=b}var f=new Image;
					f.onload=function(){i.sync();
					g(this).css({visibility:"visible"}).parents("li").removeClass("loading")};
					g(f).css({visibility:"hidden"});
					g(f).attr("data-src",c);
					if(b.caption){d.addClass("has-caption").append(g('<span class="caption" />').text(b.caption))}
					if(a==0){d.addClass("first")}
					if(a==h.length-1){d.addClass("last")}e.append(d.append(g("<div/>").append(g("<span/>").append(f))))
			}
		}
	}

	function p(a){
		if(!a.src){
			g(a).attr("src",g(a).attr("data-src"))
		}
	}

	function o(a,b){
		p(a.find("img"));
		a.nextAll().slice(0,b).add(a.prevAll().slice(0,b)).find("img").each(function(a,b){p(b)})
	}

	function n(){
		var a=g("<style />");
		g("head").prepend(a);
		var c=document.styleSheets[0];
		for(h in b.css){
			var d="";
			for(name in b.css[h]){d+=name+":"+b.css[h][name]+";"}var e=h.split(",");
			for(var f=0,h;h=e[f];++f){
				if(c.insertRule){c.insertRule(h+"{"+d+"}",c.cssRules.length)}
				else{c.addRule(h,d)}
			}
		}
	}

	function m(a){
		a.preventDefault();
		$t=g(a.target);
		if(e.find("li").length<=1){i.close()}
			if($t.is("img")){
				if($t.parents("li").is(".current")){i.next()}
				else{i.show($t)}
			}
			else if($t.is("li>div,li")){
				if($t.parents("li").is(".next")||$t.is(".next")){i.next()
				}
				else if($t.parents("li").is(".previous")||$t.is(".previous")){i.prev()}
				else{i.close()}
			}
			else{i.close()}
	}

	function l(a){
		g.each(b.keys,function(b,c){
			for(var d=0;d<c.length;++d){
				if(a.keyCode==c[d]){i[b]()}
			}
		})
	}

	function k(a){
		var b='[src="'+a+'"],[data-src="'+a+'"]';
		return $i=d.find(b).add(d.filter(b)).eq(0)}

	var c,d,e,f,g=jQuery,h=[],i=this,j=g("body");

	c=g('<div class="viewer"><ul></ul><a href="#" class="close" title="Close this viewer">&times;</a></div>').hide();
	e=c.find("ul");
	var b=g.extend({
		keys:{
			close:[27],
			prev:[37,188],
			next:[39,190]
		},
		loadAhead:1,
		preload:false,
		validateUrls:true
	},
	b);

	this.next=function(){
		this.show(f.next().find("img"))};
	this.prev=function(){
		this.show(f.prev().find("img"))};
	this.close=function(){c.hide();
	g(document).unbind("keyup.view");
	j.removeClass("viewing")};
	this.open=function(){
		c.show();g(document).bind("keyup.view",l);j.addClass("viewing");this.sync()};
	this.show=function(a){
		if(typeof a=="string"){a=k(a)}
			if(a.constructor==g&&a.length>0){
				c.find("li").removeClass("current next previous").removeAttr("title");
				f=$parent=a.parents("li").addClass("current");
				f.next().addClass("next").attr("title","Next");
				f.prev().addClass("previous").attr("title","Previous");
				this.sync();o(f,b.loadAhead)}};
	this.sync=function(){
		var a=e.find("li.current>div").height();
		var b=a+"px";e.find("li>div>span").each(function(){
			g(this).css({"line-height":b})
		});
		if(i._ie7){
			d.css({"max-height":b});
			d.each(function(){
				var b=g(this);
				b.css({top:(a-b.height())/2+"px"})
			})
		}
	};

	this.next=function(){
		i.show(f.next().find("img"))
	};

	this.prev=function(){
		i.show(f.prev().find("img"))
	};

	v()
}

View._version="1.02";

(function(){
	var a=jQuery,b=document.getElementsByTagName("script");
	if(b[b.length-1].src.indexOf("?auto")>-1){
		a().ready(function(){
			var b=a("a.view[href]");
			var c={};
			b.each(function(){
				var b=this.rel;if(b){
					if(!c[b]){c[b]=[]}c[b].push(this)
				}
			else{
				new View(a(this))}
			});
		for(var d in c){
			new View(a(c[d]))}
		})
	}
})

()